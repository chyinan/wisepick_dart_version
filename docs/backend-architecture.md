# 快淘帮 WisePick - 后端架构设计文档

**版本**: 1.0  
**创建日期**: 2024  
**最后更新**: 2024  
**文档状态**: 正式版  
**架构师**: Winston (Architect Agent)

---

## 1. 文档概述

### 1.1 文档目的

本文档详细描述了快淘帮 WisePick 项目的后端架构设计，包括代理服务器的技术栈、架构模式、核心模块设计、API 端点、集成方案等。本文档旨在：

- 为后端开发团队提供清晰的技术实现指南
- 确保新功能开发遵循统一的架构模式
- 指导系统扩展和优化决策
- 作为代码审查和架构评审的参考标准

### 1.2 文档范围

本文档涵盖：

- **技术栈**: Dart、Shelf、HTTP 客户端等核心技术选型
- **架构模式**: 代理服务器架构、无状态服务设计
- **核心模块**: AI 代理、签名服务、转链服务、配置管理等
- **API 设计**: RESTful API 端点设计、请求/响应格式
- **第三方集成**: OpenAI、淘宝联盟、京东联盟、拼多多 API 集成
- **安全架构**: API 密钥保护、签名验证、认证授权
- **部署架构**: 服务器部署方案、进程管理、环境配置

### 1.3 目标读者

- 后端开发工程师
- 系统架构师
- DevOps 工程师
- 技术负责人

---

## 2. 技术栈

### 2.1 核心技术

| 类别 | 技术 | 版本 | 用途 |
|------|------|------|------|
| 语言 | Dart | 3.9.2+ | 编程语言 |
| Web 框架 | Shelf | 1.4.0+ | HTTP 服务器框架 |
| 路由 | shelf_router | 1.0.0+ | 路由管理 |
| HTTP 客户端 | http | 0.13.0+ | 外部 API 调用 |
| 加密 | crypto | 3.0.2+ | 签名算法、密码哈希 |
| 浏览器自动化 | puppeteer | 2.2.0+ | 网页抓取（可选） |

### 2.2 技术选型理由

**Dart + Shelf**:
- 与前端使用相同语言，代码可复用
- 轻量级框架，易于部署和维护
- 支持异步处理，性能优秀
- 跨平台支持（Linux、Windows、macOS）

**Shelf Router**:
- 简洁的路由定义
- 支持中间件模式
- RESTful API 设计友好

**HTTP Package**:
- Dart 官方 HTTP 客户端
- 支持流式响应
- 异步非阻塞

---

## 3. 整体架构

### 3.1 架构模式

后端采用**代理服务器架构**，主要特点：

- **无状态设计**: 每个请求独立处理，不维护会话状态
- **代理转发**: 作为前端和第三方 API 之间的中间层
- **统一接口**: 为前端提供统一的 API 接口
- **安全隔离**: 保护 API 密钥，统一处理签名和认证

### 3.2 架构分层

```
┌─────────────────────────────────────────────────────────────┐
│                    HTTP 请求层                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Flutter App │  │  Web Client  │  │  Other Apps  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    路由层 (Shelf Router)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  API Routes  │  │  Auth Routes │  │ Debug Routes │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                  业务处理层 (Request Handlers)                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ AI Proxy     │  │ Sign Service │  │ Link Service │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Search Proxy │  │ Config Mgmt  │  │ Admin Auth   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                  集成层 (Third-party APIs)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ OpenAI API   │  │ 淘宝联盟 API │  │ 京东联盟 API │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐                                           │
│  │ 拼多多 API   │                                           │
│  └──────────────┘                                           │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 核心职责

1. **API 代理转发**: 转发前端请求到第三方 API，保护 API 密钥
2. **签名服务**: 为淘宝、京东、拼多多 API 生成签名
3. **转链服务**: 将普通商品链接转换为推广链接
4. **配置管理**: 环境变量管理、交互式配置
5. **认证授权**: 管理员登录验证
6. **调试支持**: 调试端点、日志记录

---

## 4. 核心模块设计

### 4.1 AI 代理模块

#### 4.1.1 模块职责

- 代理转发 OpenAI 兼容 API 请求
- 支持流式响应和非流式响应
- 处理 CORS 跨域请求
- API Key 管理和转发

#### 4.1.2 核心功能

**端点**: `POST /v1/chat/completions`

**功能特性**:
- 支持流式响应（Server-Sent Events）
- 支持非流式响应（标准 JSON）
- 自动检测请求中的 `stream` 参数
- 转发 Authorization Header（API Key 由前端提供）
- CORS 支持

**请求处理流程**:
1. 接收前端请求
2. 读取请求体，检测是否为流式请求
3. 构建上游请求（OpenAI API 或兼容服务）
4. 转发请求并处理响应
5. 流式响应：直接转发字节流
6. 非流式响应：等待完整响应后返回

**配置项**:
- `OPENAI_API_URL`: 上游 API 地址（默认: `https://api.openai.com/v1/chat/completions`）
- `OPENAI_API_KEY`: API Key（可选，也可由前端在请求中提供）

### 4.2 签名服务模块

#### 4.2.1 模块职责

- 为淘宝、京东、拼多多 API 生成签名
- 实现各平台的签名算法
- 时间戳管理
- 签名验证

#### 4.2.2 淘宝签名服务

**端点**: `POST /sign/taobao`

**签名算法**: HMAC-SHA256

**签名流程**:
1. 读取请求体数据
2. 获取时间戳（从 Header `x-ts` 或自动生成）
3. 拼接数据：`body + timestamp`
4. 使用 `TAOBAO_APP_SECRET` 计算 HMAC-SHA256
5. 返回签名和时间戳

**配置项**:
- `TAOBAO_APP_SECRET`: 淘宝应用密钥

#### 4.2.3 京东签名服务

**端点**: `POST /sign/jd`

**签名算法**: HMAC-SHA256（与淘宝相同）

**签名流程**:
1. 读取请求体数据
2. 获取时间戳（从 Header `x-ts` 或自动生成）
3. 拼接数据：`body + timestamp`
4. 使用 `JD_APP_SECRET` 计算 HMAC-SHA256
5. 返回签名和时间戳

**配置项**:
- `JD_APP_SECRET`: 京东联盟密钥

#### 4.2.4 拼多多签名服务

**端点**: `POST /sign/pdd`

**签名算法**: MD5

**签名流程**:
1. 读取请求参数
2. 按参数名排序
3. 拼接参数值
4. 使用 `PDD_CLIENT_SECRET` 计算 MD5
5. 返回签名结果

**配置项**:
- `PDD_CLIENT_ID`: 拼多多客户端 ID
- `PDD_CLIENT_SECRET`: 拼多多客户端密钥

### 4.3 淘宝联盟集成模块

#### 4.3.1 商品搜索

**端点**: `GET /taobao/tbk_search`

**功能**:
- 调用淘宝联盟商品搜索 API
- 支持关键词搜索
- 支持分页、排序、筛选
- 自动处理签名和请求构建

**请求参数**:
- `para`: 搜索关键词（必需）
- `page_no`: 页码
- `page_size`: 每页数量
- `cat`: 类目 ID
- `sort`: 排序方式
- `adzone_id`: 推广位 ID
- `has_coupon`: 是否有优惠券

**签名算法**: MD5
- 格式：`MD5(appSecret + key1value1key2value2... + appSecret).toUpperCase()`
- 参数按 key 排序后拼接

**配置项**:
- `TAOBAO_APP_KEY`: 淘宝应用 Key
- `TAOBAO_APP_SECRET`: 淘宝应用密钥
- `TAOBAO_ADZONE_ID`: 默认推广位 ID（可选）

#### 4.3.2 链接转换

**端点**: `POST /taobao/convert`

**功能**:
- 将普通商品链接转换为推广链接
- 生成淘宝口令（tpwd）
- 返回短链接

**请求参数**:
- `id`: 商品 ID
- `url`: 商品链接

**响应格式**:
- `coupon_share_url`: 推广链接
- `clickURL`: 点击链接
- `tpwd`: 淘宝口令

### 4.4 京东联盟集成模块

#### 4.4.1 商品搜索

**端点**: `GET /jd/union/goods/query`

**功能**:
- 调用京东联盟商品搜索 API
- 支持关键词搜索
- 支持多种筛选条件
- 自动处理 OAuth 认证

**请求参数**:
- `keyword`: 搜索关键词
- `pageIndex`: 页码
- `pageSize`: 每页数量
- `sortName`: 排序字段
- `sort`: 排序方式

**签名算法**: MD5
- 格式：`MD5(appSecret + k1v1k2v2... + appSecret).toUpperCase()`
- 参数按 key 排序后拼接
- 时间戳使用 GMT+8 时区

**配置项**:
- `JD_APP_KEY`: 京东应用 Key
- `JD_APP_SECRET`: 京东联盟密钥
- `JD_UNION_ID`: 京东联盟 ID

#### 4.4.2 推广链接生成

**端点**: `POST /jd/union/promotion/bysubunionid`

**功能**:
- 通过 subUnionId 生成推广链接
- 支持多种推广方式
- 返回短链接和长链接

**请求参数**:
- `promotionCodeReq`: 推广请求对象
  - `materialId`: 商品链接或 ID
  - `sceneId`: 场景 ID
  - `chainType`: 链接类型
  - `subUnionId`: 子联盟 ID（可选）
  - `pid`: PID（可选）

**响应格式**:
- `clickURL`: 推广链接
- `shortURL`: 短链接

### 4.5 拼多多集成模块

#### 4.5.1 商品搜索

**端点**: `GET /api/products/search`（通过拼多多 API）

**功能**:
- 调用拼多多商品搜索 API
- 支持关键词搜索
- 支持多种筛选条件

**配置项**:
- `PDD_CLIENT_ID`: 拼多多客户端 ID
- `PDD_CLIENT_SECRET`: 拼多多客户端密钥

#### 4.5.2 推广链接生成

**端点**: `POST /pdd/rp/prom/generate`

**功能**:
- 生成拼多多推广链接
- 支持批量商品推广
- 返回移动端和 PC 端链接

**请求参数**:
- `goods_sign_list`: 商品签名列表
- `custom_parameters`: 自定义参数（JSON 字符串）
- `pid`: 推广位 ID

**响应格式**:
- `mobile_url`: 移动端链接
- `url`: PC 端链接

#### 4.5.3 备案查询

**端点**: `POST /pdd/authority/query`

**功能**:
- 查询拼多多备案信息
- 生成小程序备案链接

**配置项**:
- `PDD_PID`: 拼多多推广位 ID

### 4.6 配置管理模块

#### 4.6.1 交互式启动

**功能**:
- 启动时检测环境变量
- 提示用户输入缺失的配置项
- 自动保存配置到 `.env` 文件
- 支持配置合并和覆盖

**配置项检测**:
- 淘宝联盟配置（App Key、App Secret、Adzone ID）
- 京东联盟配置（App Key、App Secret、Union ID）
- 拼多多配置（Client ID、Client Secret、PID）
- 管理员密码（ADMIN_PASSWORD）
- 服务器端口（PORT）

**配置持久化**:
- 配置保存到 `server/.env` 文件
- 支持环境变量和 `.env` 文件两种方式
- `.env` 文件不应提交到版本控制

#### 4.6.2 端口管理

**功能**:
- 默认端口：8080
- 端口被占用时自动尝试下一个可用端口（最多 10 次）
- 通过 `PORT` 环境变量可强制绑定指定端口

#### 4.6.3 设置端点

**端点**: `GET /__settings`

**功能**:
- 返回后端基础配置信息
- 供前端读取后端地址等配置

**响应格式**:
```json
{
  "backend_base": "http://localhost:8080"
}
```

### 4.7 认证授权模块

#### 4.7.1 管理员登录

**端点**: `POST /admin/login`

**功能**:
- 验证管理员密码
- 用于解锁前端后台设置界面
- 使用常量时间比较防止时序攻击

**请求格式**:
```json
{
  "password": "管理员密码"
}
```

**响应格式**:
```json
{
  "success": true
}
```

**安全特性**:
- 使用 `_constantTimeEquals()` 函数防止时序攻击
- 密码通过环境变量 `ADMIN_PASSWORD` 配置
- 支持 JSON 和表单格式请求

### 4.8 调试支持模块

#### 4.8.1 调试端点

**端点**: `GET /__debug/last_return`

**功能**:
- 查看最后一次 API 返回的调试信息
- 支持查看历史记录（通过 `?history=1` 参数）
- 存储最近 20 条调试记录

**查询参数**:
- `history`: 设置为 `1` 时返回历史记录列表

**响应格式**:
```json
{
  "ok": true,
  "history": [
    {
      "path": "/taobao/tbk_search",
      "query": "搜索关键词",
      "body": {...},
      "ts": "2024-01-01T00:00:00Z"
    }
  ]
}
```

#### 4.8.2 价格缓存

**功能**:
- 内存缓存商品价格信息
- 减少重复 API 调用
- 提升响应速度

**缓存结构**:
- Key: 商品 SKU ID
- Value: `{price: double, expiry: int}`

**缓存策略**:
- 内存存储，应用重启后清空
- 可配置过期时间

---

## 5. API 设计

### 5.1 API 端点总览

#### 5.1.1 AI 相关端点

| 端点 | 方法 | 功能 |
|------|------|------|
| `/v1/chat/completions` | POST | OpenAI API 代理转发 |

#### 5.1.2 签名服务端点

| 端点 | 方法 | 功能 |
|------|------|------|
| `/sign/taobao` | POST | 淘宝 API 签名 |
| `/sign/jd` | POST | 京东 API 签名 |
| `/sign/pdd` | POST | 拼多多 API 签名 |

#### 5.1.3 淘宝联盟端点

| 端点 | 方法 | 功能 |
|------|------|------|
| `/taobao/tbk_search` | GET | 商品搜索 |
| `/taobao/convert` | POST | 链接转换 |

#### 5.1.4 京东联盟端点

| 端点 | 方法 | 功能 |
|------|------|------|
| `/jd/union/goods/query` | GET | 商品搜索 |
| `/jd/union/promotion/bysubunionid` | POST | 推广链接生成 |
| `/proxy/test/jd_search` | GET | 测试搜索（调试用） |

#### 5.1.5 拼多多端点

| 端点 | 方法 | 功能 |
|------|------|------|
| `/api/products/search` | GET | 商品搜索 |
| `/pdd/authority/query` | POST | 备案查询 |
| `/pdd/rp/prom/generate` | POST | 推广链接生成 |
| `/pdd/search_debug` | POST | 搜索调试 |

#### 5.1.6 管理端点

| 端点 | 方法 | 功能 |
|------|------|------|
| `/admin/login` | POST | 管理员登录 |
| `/__settings` | GET | 获取配置信息 |
| `/__debug/last_return` | GET | 调试信息查看 |
| `/api/get-jd-promotion` | GET | 获取京东推广链接 |

### 5.2 请求/响应格式

#### 5.2.1 统一响应格式

**成功响应**:
- HTTP 状态码: 200
- Content-Type: `application/json`
- 响应体: JSON 格式数据

**错误响应**:
- HTTP 状态码: 4xx/5xx
- Content-Type: `application/json`
- 响应体格式:
```json
{
  "error": "错误描述",
  "status": 500,
  "debug": {...}
}
```

#### 5.2.2 CORS 支持

所有端点支持 CORS，响应头包含：
- `access-control-allow-origin: *`
- `access-control-allow-methods: POST, OPTIONS`
- `access-control-allow-headers: Origin, Content-Type, Accept, Authorization`

### 5.3 错误处理

#### 5.3.1 错误类型

**配置错误**:
- 缺失必需的环境变量
- 配置项格式错误
- 响应: 500 Internal Server Error

**API 错误**:
- 第三方 API 调用失败
- 签名验证失败
- 响应: 400/500 + 错误详情

**请求错误**:
- 参数缺失或格式错误
- 响应: 400 Bad Request

#### 5.3.2 错误处理策略

- 统一错误响应格式
- 记录错误日志（调试模式）
- 返回友好的错误信息
- 保护敏感信息（生产环境）

---

## 6. 数据流设计

### 6.1 AI 代理数据流

```
前端请求
  ↓
POST /v1/chat/completions
  ↓
读取请求体，检测 stream 参数
  ↓
构建上游请求（OpenAI API）
  ↓
转发请求（携带 API Key）
  ↓
接收响应
  ├── 流式响应 → 直接转发字节流
  └── 非流式响应 → 等待完整响应后返回
  ↓
返回给前端（添加 CORS 头）
```

### 6.2 签名服务数据流

```
前端请求
  ↓
POST /sign/{platform}
  ↓
读取请求体
  ↓
获取时间戳（Header 或自动生成）
  ↓
拼接签名数据
  ↓
计算签名（HMAC-SHA256 或 MD5）
  ↓
返回签名和时间戳
```

### 6.3 商品搜索数据流

```
前端请求
  ↓
GET /{platform}/search
  ↓
读取查询参数
  ↓
构建平台 API 请求参数
  ↓
计算签名
  ↓
调用第三方 API
  ↓
解析响应数据
  ↓
标准化数据格式
  ↓
返回给前端
```

### 6.4 推广链接生成数据流

```
前端请求
  ↓
POST /{platform}/promotion
  ↓
读取请求参数
  ↓
构建推广请求
  ↓
计算签名
  ↓
调用第三方 API
  ↓
解析推广链接
  ↓
返回推广链接和相关信息
```

---

## 7. 安全架构

### 7.1 API 密钥保护

#### 7.1.1 密钥存储

**环境变量**:
- 所有 API 密钥通过环境变量配置
- 不硬编码在代码中
- 支持 `.env` 文件（不提交到版本控制）

**密钥类型**:
- `OPENAI_API_KEY`: OpenAI API 密钥
- `TAOBAO_APP_KEY` / `TAOBAO_APP_SECRET`: 淘宝联盟密钥
- `JD_APP_KEY` / `JD_APP_SECRET`: 京东联盟密钥
- `PDD_CLIENT_ID` / `PDD_CLIENT_SECRET`: 拼多多密钥
- `ADMIN_PASSWORD`: 管理员密码

#### 7.1.2 密钥使用

- 密钥仅在服务器端使用
- 不暴露给前端
- 签名计算在服务器端完成
- 前端通过代理访问第三方 API

### 7.2 签名安全

#### 7.2.1 签名算法

**淘宝/京东**:
- 使用 MD5 签名算法
- 参数按 key 排序后拼接
- 格式: `MD5(secret + k1v1k2v2... + secret).toUpperCase()`

**拼多多**:
- 使用 MD5 签名算法
- 参数按 key 排序后拼接
- 格式: `MD5(secret + k1v1k2v2... + secret)`

#### 7.2.2 时间戳验证

- 使用 GMT+8 时区时间戳
- 防止重放攻击
- 时间戳包含在签名计算中

### 7.3 认证授权

#### 7.3.1 管理员认证

**实现方式**:
- 密码哈希验证
- 常量时间比较（防止时序攻击）
- 支持 JSON 和表单格式

**安全特性**:
- 密码不存储在代码中
- 通过环境变量配置
- 使用 `_constantTimeEquals()` 函数

### 7.4 网络安全

#### 7.4.1 HTTPS 支持

**要求**:
- 生产环境必须使用 HTTPS
- 使用有效的 SSL 证书
- 保护数据传输安全

#### 7.4.2 CORS 配置

**当前配置**:
- 允许所有来源（`*`）
- 开发环境使用

**生产环境建议**:
- 限制允许的来源
- 配置具体的域名白名单
- 添加请求频率限制

---

## 8. 性能优化

### 8.1 请求优化

#### 8.1.1 超时控制

**配置**:
- 连接超时: 8-12 秒（根据 API 类型）
- 接收超时: 根据响应大小调整
- 流式响应: 支持长时间连接

#### 8.1.2 并发处理

**特性**:
- 异步非阻塞处理
- 支持并发请求
- 使用 Dart 的 `async/await`

### 8.2 缓存策略

#### 8.2.1 价格缓存

**实现**:
- 内存缓存商品价格
- 减少重复 API 调用
- 提升响应速度

#### 8.2.2 响应缓存

**考虑**:
- 对于相同请求，可缓存响应
- 设置合理的过期时间
- 支持缓存失效

### 8.3 资源管理

#### 8.3.1 HTTP 客户端

**优化**:
- 复用 HTTP 客户端实例
- 连接池管理
- 及时释放资源

#### 8.3.2 内存管理

**策略**:
- 限制调试历史记录数量（最多 20-50 条）
- 定期清理过期缓存
- 监控内存使用

---

## 9. 部署架构

### 9.1 服务器要求

#### 9.1.1 系统要求

- **操作系统**: Linux (推荐 Ubuntu 20.04+)、Windows、macOS
- **Dart SDK**: 3.9.2+
- **内存**: 至少 512MB
- **网络**: 可访问外部 API（OpenAI、淘宝、京东、拼多多）

#### 9.1.2 依赖安装

**Ubuntu/Debian**:
```bash
sudo apt-get update
sudo apt-get install dart
```

**macOS**:
```bash
brew install dart
```

### 9.2 部署步骤

#### 9.2.1 代码部署

1. **克隆仓库**
   ```bash
   git clone <repo-url>
   cd wisepick_dart_version/server
   ```

2. **安装依赖**
   ```bash
   dart pub get
   ```

3. **配置环境变量**
   - 创建 `.env` 文件
   - 或使用系统环境变量
   - 配置所有必需的密钥

4. **启动服务**
   ```bash
   dart run bin/proxy_server.dart
   ```

#### 9.2.2 进程管理

**使用 PM2** (推荐):
```bash
npm install -g pm2
pm2 start "dart run bin/proxy_server.dart" --name wisepick-proxy
pm2 save
pm2 startup
```

**使用 systemd**:
```ini
[Unit]
Description=WisePick Proxy Server
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/path/to/server
Environment="PATH=/usr/lib/dart/bin:$PATH"
ExecStart=/usr/lib/dart/bin/dart run bin/proxy_server.dart
Restart=always

[Install]
WantedBy=multi-user.target
```

#### 9.2.3 反向代理 (Nginx)

```nginx
server {
    listen 80;
    server_name api.yourdomain.com;

    location / {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

#### 9.2.4 环境配置

**开发环境**:
- 本地运行，端口 8080
- 使用 `.env` 文件配置
- 启用调试模式

**生产环境**:
- 使用 HTTPS
- 配置域名和 SSL 证书
- 限制 CORS 来源
- 启用日志记录
- 配置监控和告警

### 9.3 监控和日志

#### 9.3.1 日志记录

**日志内容**:
- 请求信息（端点、方法、参数）
- 响应信息（状态码、耗时）
- 错误信息（堆栈、上下文）
- 第三方 API 调用记录

**日志存储**:
- 控制台输出（开发环境）
- 文件日志（生产环境，按日期轮转）
- 可选: 远程日志服务（如 Sentry）

#### 9.3.2 性能监控

**关键指标**:
- API 响应时间
- 请求处理速率
- 错误率
- 资源使用（CPU、内存）

**监控方法**:
- 请求日志分析
- 系统资源监控
- 可选: APM 工具集成

---

## 10. 测试策略

### 10.1 单元测试

#### 10.1.1 签名算法测试

**测试范围**:
- 淘宝签名算法
- 京东签名算法
- 拼多多签名算法
- 时间戳生成

**测试工具**: Dart `test` package

**测试示例**:
- 测试签名计算正确性
- 测试参数排序
- 测试时间戳格式

#### 10.1.2 工具函数测试

**测试范围**:
- 常量时间比较函数
- URL 规范化函数
- 数据转换函数
- 错误处理函数

### 10.2 集成测试

#### 10.2.1 API 端点测试

**测试范围**:
- 所有 API 端点响应
- 请求/响应格式验证
- 错误处理验证

**测试方法**:
- 使用 Mock HTTP 客户端
- 测试真实 API 调用（开发环境）
- 验证签名和认证

#### 10.2.2 第三方 API 集成测试

**测试范围**:
- OpenAI API 代理
- 淘宝联盟 API 集成
- 京东联盟 API 集成
- 拼多多 API 集成

**测试场景**:
- 正常请求流程
- 错误处理流程
- 超时处理
- 重试机制

### 10.3 测试覆盖率目标

- **单元测试**: > 60%
- **集成测试**: 核心流程 100%
- **API 测试**: 所有端点

### 10.4 测试环境

**开发环境**:
- 使用 Mock 数据
- 本地测试服务器
- 调试模式启用

**CI/CD 环境**:
- 自动化测试执行
- 覆盖率报告生成
- 测试结果通知

---

## 11. 扩展性设计

### 11.1 水平扩展

#### 11.1.1 无状态设计

**特点**:
- 每个请求独立处理
- 不维护会话状态
- 支持多实例部署

**优势**:
- 易于水平扩展
- 支持负载均衡
- 故障恢复简单

#### 11.1.2 负载均衡

**方案**:
- 使用 Nginx 作为负载均衡器
- 多实例部署
- 健康检查机制

### 11.2 垂直扩展

#### 11.2.1 性能优化

**优化方向**:
- 缓存策略优化
- 连接池管理
- 异步处理优化
- 资源使用优化

#### 11.2.2 资源限制

**配置**:
- 内存限制
- CPU 限制
- 并发连接数限制
- 请求超时配置

### 11.3 功能扩展

#### 11.3.1 新平台接入

**扩展步骤**:
1. 实现签名算法
2. 添加 API 端点
3. 实现请求/响应转换
4. 添加配置项
5. 更新文档

**设计优势**:
- 统一接口设计
- 易于添加新平台
- 不影响现有功能

#### 11.3.2 新功能模块

**扩展方式**:
- 添加新的路由端点
- 实现新的业务逻辑
- 遵循现有架构模式
- 最小化对现有代码的影响

---

## 12. 错误处理和监控

### 12.1 错误处理策略

#### 12.1.1 错误分类

**配置错误**:
- 缺失环境变量
- 配置格式错误
- 处理: 返回 500 错误，记录日志

**API 错误**:
- 第三方 API 调用失败
- 签名验证失败
- 处理: 返回相应错误码，提供错误详情

**请求错误**:
- 参数缺失
- 参数格式错误
- 处理: 返回 400 错误，提示具体问题

#### 12.1.2 错误响应格式

**统一格式**:
```json
{
  "error": "错误描述",
  "status": 500,
  "message": "详细错误信息",
  "debug": {...}
}
```

**调试模式**:
- 返回详细错误信息
- 包含堆栈跟踪
- 记录调试历史

**生产模式**:
- 隐藏敏感信息
- 返回友好错误提示
- 记录详细日志

### 12.2 日志和监控

#### 12.2.1 日志级别

**Debug**: 开发调试信息
**Info**: 正常操作信息
**Warning**: 警告信息
**Error**: 错误信息

#### 12.2.2 日志内容

**请求日志**:
- 端点、方法、参数
- 请求时间
- 响应时间
- 状态码

**错误日志**:
- 错误类型和消息
- 错误堆栈
- 上下文信息
- 时间戳

#### 12.2.3 监控指标

**性能指标**:
- API 响应时间
- 请求处理速率
- 错误率
- 资源使用率

**业务指标**:
- API 调用次数
- 各平台调用分布
- 成功率
- 缓存命中率

---

## 13. 技术债务和未来改进

### 13.1 当前技术债务

#### 13.1.1 代码质量

**待改进项**:
- 部分代码可进一步模块化
- 错误处理可以更统一
- 测试覆盖率需要提升
- 文档需要完善

#### 13.1.2 架构优化

**待改进项**:
- 可以引入中间件模式
- 配置管理可以更集中
- 日志系统可以更完善
- 监控系统可以更完善

### 13.2 未来改进方向

#### 13.2.1 短期改进 (3 个月内)

- [ ] 完善单元测试覆盖
- [ ] 统一错误处理机制
- [ ] 优化性能瓶颈
- [ ] 完善文档和注释
- [ ] 添加请求限流

#### 13.2.2 中期改进 (6 个月内)

- [ ] 引入中间件框架
- [ ] 实现配置中心
- [ ] 引入监控和告警系统
- [ ] 优化缓存策略
- [ ] 添加 API 版本控制

#### 13.2.3 长期改进 (1 年内)

- [ ] 微服务架构改造（如需要）
- [ ] 实现分布式追踪
- [ ] 添加 API 网关功能
- [ ] 实现服务发现
- [ ] 多租户支持

---

## 14. 架构决策记录 (ADR)

### 14.1 ADR-001: 选择 Dart Shelf 作为后端框架

**决策**: 使用 Shelf 作为后端 Web 框架

**理由**:
- 与前端使用相同语言（Dart）
- 轻量级，易于部署
- 支持异步处理
- 代码复用

**后果**:
- 前后端代码可以共享
- Dart 后端生态相对较小
- 需要自行实现部分功能

### 14.2 ADR-002: 采用代理服务器架构

**决策**: 后端作为代理服务器，转发请求到第三方 API

**理由**:
- 保护 API 密钥安全
- 统一处理签名和认证
- 简化前端实现
- 便于统一管理

**后果**:
- 增加一层网络跳转
- 需要维护代理服务器
- 可以统一添加功能（缓存、限流等）

### 14.3 ADR-003: 使用环境变量管理配置

**决策**: 所有配置通过环境变量管理

**理由**:
- 安全性高，不暴露密钥
- 便于不同环境配置
- 符合 12-Factor App 原则
- 支持交互式配置

**后果**:
- 需要管理环境变量
- 配置变更需要重启服务
- 支持 `.env` 文件便于开发

### 14.4 ADR-004: 无状态服务设计

**决策**: 后端服务采用无状态设计

**理由**:
- 易于水平扩展
- 支持负载均衡
- 故障恢复简单
- 简化部署

**后果**:
- 不能维护会话状态
- 每次请求需要完整信息
- 适合 RESTful API 设计

---

## 15. 总结

### 15.1 架构特点

快淘帮 WisePick 后端架构具有以下特点：

1. **代理服务器架构**: 作为前端和第三方 API 之间的中间层
2. **无状态设计**: 易于扩展和部署
3. **统一接口**: 为前端提供统一的 API 接口
4. **安全隔离**: 保护 API 密钥，统一处理签名
5. **轻量级框架**: Shelf 框架，易于维护
6. **跨平台支持**: Dart 语言，支持多平台部署

### 15.2 技术优势

- **开发效率**: 与前端使用相同语言，代码可复用
- **易于部署**: 轻量级框架，部署简单
- **性能优秀**: 异步非阻塞，支持并发
- **安全可靠**: 密钥保护，签名验证
- **易于扩展**: 无状态设计，支持水平扩展

### 15.3 适用场景

本架构适用于：
- API 代理服务
- 第三方 API 集成
- 需要保护 API 密钥的场景
- 需要统一处理签名和认证的场景
- 轻量级后端服务

### 15.4 后续工作

1. **完善测试**: 提升测试覆盖率
2. **性能优化**: 持续优化性能瓶颈
3. **功能扩展**: 按需求逐步实现新功能
4. **文档完善**: 保持文档与代码同步
5. **监控告警**: 完善监控和告警系统

---

## 16. 附录

### 16.1 参考文档

- [PRD 文档](../PRD.md) - 产品需求文档
- [架构文档](./architecture.md) - 完整技术架构文档
- [前端架构文档](./frontend-architecture.md) - 前端架构设计文档
- [README](../README.md) - 项目说明文档
- [Shelf 文档](https://pub.dev/packages/shelf) - Shelf 框架文档
- [Dart 官方文档](https://dart.dev/) - Dart 语言文档

### 16.2 相关工具

- **Dart SDK**: Dart 开发工具包
- **PM2**: 进程管理工具
- **Nginx**: 反向代理服务器
- **systemd**: Linux 系统服务管理

### 16.3 环境变量参考

#### 必需配置

- `ADMIN_PASSWORD`: 管理员密码

#### 可选配置（按需）

**OpenAI**:
- `OPENAI_API_URL`: OpenAI API 地址
- `OPENAI_API_KEY`: OpenAI API Key（也可由前端提供）

**淘宝联盟**:
- `TAOBAO_APP_KEY`: 淘宝应用 Key
- `TAOBAO_APP_SECRET`: 淘宝应用密钥
- `TAOBAO_ADZONE_ID`: 淘宝推广位 ID

**京东联盟**:
- `JD_APP_KEY`: 京东应用 Key
- `JD_APP_SECRET`: 京东联盟密钥
- `JD_UNION_ID`: 京东联盟 ID

**拼多多**:
- `PDD_CLIENT_ID`: 拼多多客户端 ID
- `PDD_CLIENT_SECRET`: 拼多多客户端密钥
- `PDD_PID`: 拼多多推广位 ID

**服务器配置**:
- `PORT`: 服务器端口（默认: 8080）
- `BACKEND_BASE`: 后端基础地址

### 16.4 API 端点参考

#### AI 相关
- `POST /v1/chat/completions` - OpenAI API 代理

#### 签名服务
- `POST /sign/taobao` - 淘宝签名
- `POST /sign/jd` - 京东签名
- `POST /sign/pdd` - 拼多多签名

#### 淘宝联盟
- `GET /taobao/tbk_search` - 商品搜索
- `POST /taobao/convert` - 链接转换

#### 京东联盟
- `GET /jd/union/goods/query` - 商品搜索
- `POST /jd/union/promotion/bysubunionid` - 推广链接生成

#### 拼多多
- `GET /api/products/search` - 商品搜索
- `POST /pdd/authority/query` - 备案查询
- `POST /pdd/rp/prom/generate` - 推广链接生成

#### 管理端点
- `POST /admin/login` - 管理员登录
- `GET /__settings` - 获取配置信息
- `GET /__debug/last_return` - 调试信息查看

### 16.5 变更日志

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| 1.0 | 2024 | 初始后端架构文档 | CHYINAN (Architect) |

---

**文档维护者**: 架构团队  
**审核者**: 技术团队  
**批准者**: 技术负责人

---

*本文档基于项目实际代码和 PRD 需求编写，反映了当前后端系统的真实架构状态。*