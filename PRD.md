# 快淘帮 WisePick - 产品需求文档 (PRD)

**版本**: 1.0  
**创建日期**: 2024  
**最后更新**: 2024  
**文档状态**: 正式版

---

## 1. 产品概述

### 1.1 产品定位
快淘帮 WisePick 是一款基于 AI 的智能购物推荐应用，通过自然语言对话帮助用户在多平台（淘宝、京东、拼多多）中快速找到心仪商品，并提供推广链接生成、选品车管理等一站式购物辅助服务。

### 1.2 产品愿景
成为用户最信赖的智能购物助手，通过 AI 技术简化购物决策流程，提升购物体验。

### 1.3 核心价值主张
- **智能推荐**: 基于 AI 理解用户需求，提供个性化商品推荐
- **多平台聚合**: 统一搜索淘宝、京东、拼多多三大电商平台
- **推广链接**: 自动生成联盟推广链接，支持佣金收益
- **选品管理**: 提供选品车功能，方便用户收藏和比价

---

## 2. 目标用户

### 2.1 主要用户群体
- **购物达人**: 经常网购，需要快速找到性价比高的商品
- **联盟推广者**: 需要生成推广链接进行商品推广
- **价格敏感用户**: 希望在不同平台间比价，找到最优价格
- **决策困难用户**: 需要 AI 辅助进行购物决策

### 2.2 用户画像
- **年龄**: 18-45 岁
- **地域**: 中国大陆
- **设备**: 支持 Windows、macOS、Linux、Android、iOS、Web
- **使用场景**: 日常购物、选品、比价、推广

---

## 3. 核心功能模块

### 3.1 AI 助手聊天模块
**功能描述**: 通过自然语言对话，理解用户购物需求，提供商品推荐和购物建议。

**核心特性**:
- 支持流式响应，实时显示 AI 回复
- 智能识别用户意图（推荐请求 vs 普通问答）
- 支持结构化 JSON 推荐和自然语言回复
- 会话历史管理，支持多会话切换
- 自动生成会话标题

**技术实现**:
- 集成 OpenAI API（支持自定义 API 地址和模型）
- 支持本地代理服务器转发请求
- 支持 Mock 模式用于离线开发
- 可配置 Prompt 嵌入、调试模式等高级选项

**用户故事**:
- 作为用户，我希望通过自然语言描述我的需求，AI 能理解并推荐合适的商品
- 作为用户，我希望看到 AI 实时生成回复，而不是等待完整响应
- 作为用户，我希望能够查看和管理历史对话记录

### 3.2 商品搜索模块
**功能描述**: 支持在淘宝、京东、拼多多三大平台搜索商品，并统一展示结果。

**核心特性**:
- 多平台并行搜索（淘宝、京东、拼多多）
- 搜索结果去重和合并（优先显示京东结果）
- 支持分页加载
- 商品信息统一展示（标题、价格、图片、销量、评分等）
- 支持平台筛选（单平台或全平台）

**技术实现**:
- 使用 Adapter 模式适配不同平台 API
- 统一商品模型 `ProductModel` 封装
- 支持缓存机制提升性能

**用户故事**:
- 作为用户，我希望输入关键词后能同时搜索多个平台
- 作为用户，我希望看到统一的商品展示格式，方便比较
- 作为用户，我希望能够按平台筛选搜索结果

### 3.3 商品详情模块
**功能描述**: 展示商品详细信息，包括价格、图片、描述、店铺信息等。

**核心特性**:
- 商品详细信息展示
- 价格历史趋势（如支持）
- 推广链接生成和复制
- 一键加入选品车
- 外部链接跳转

**用户故事**:
- 作为用户，我希望查看商品的详细信息
- 作为用户，我希望能够快速复制推广链接
- 作为用户，我希望能够将感兴趣的商品加入选品车

### 3.4 选品车模块
**功能描述**: 管理用户收藏的商品，支持批量操作和价格监控。

**核心特性**:
- 商品添加/删除
- 按店铺分组显示
- 商品数量调整
- 批量选择/取消选择
- 价格自动刷新（后台服务）
- 结算功能（复制推广链接）
- 价格变化通知

**技术实现**:
- 使用 Hive 本地存储
- Riverpod 状态管理
- 后台价格刷新服务 `PriceRefreshService`
- 本地通知服务 `NotificationService`

**用户故事**:
- 作为用户，我希望能够保存感兴趣的商品到选品车
- 作为用户，我希望选品车中的商品价格能够自动更新
- 作为用户，我希望当商品降价时能收到通知
- 作为用户，我希望能够批量管理选品车中的商品

### 3.5 推广链接生成模块
**功能描述**: 为商品自动生成联盟推广链接，支持淘宝、京东、拼多多。

**核心特性**:
- 自动生成推广链接
- 链接缓存机制（30 分钟有效期）
- 支持强制刷新
- 支持复制链接
- 支持口令（tpwd）和短链接

**技术实现**:
- 后端代理服务处理签名和转链
- 支持淘宝、京东、拼多多不同 API
- 本地缓存和持久化存储

**用户故事**:
- 作为推广者，我希望能够快速为商品生成推广链接
- 作为推广者，我希望生成的链接能够自动缓存，避免重复请求
- 作为推广者，我希望能够复制推广链接或口令

### 3.6 管理员设置模块
**功能描述**: 提供高级配置选项，包括 API 设置、后端配置、调试选项等。

**核心特性**:
- OpenAI API Key 配置
- 后端代理地址配置
- AI 模型选择（支持获取可用模型列表）
- Prompt 嵌入开关
- 调试模式（显示原始 JSON 响应）
- Mock AI 模式（离线开发）
- Max Tokens 配置
- 京东联盟参数配置（subUnionId、pid）

**用户故事**:
- 作为管理员，我希望能够配置 AI API 相关参数
- 作为管理员，我希望能够切换不同的 AI 模型
- 作为开发者，我希望能够启用调试模式查看原始响应

---

## 4. 技术架构

### 4.1 前端架构
**技术栈**:
- **框架**: Flutter (Dart 3.9.2+)
- **状态管理**: Riverpod 2.5.1
- **本地存储**: Hive 2.2.3
- **网络请求**: Dio 5.1.2
- **UI 组件**: Material Design 3
- **字体**: Noto Sans SC（中文字体支持）

**架构模式**:
- **MVVM**: 使用 Riverpod 进行状态管理
- **Adapter 模式**: 商品搜索适配不同平台
- **Service 层**: 业务逻辑封装在 Service 中
- **Repository 模式**: 数据访问层抽象

**目录结构**:
```
lib/
├── core/              # 核心功能（API 客户端、配置、OAuth 等）
├── features/           # 功能模块
│   ├── chat/          # 聊天功能
│   ├── products/      # 商品功能
│   └── cart/          # 选品车功能
├── screens/           # 页面组件
├── services/          # 业务服务
├── widgets/           # 通用组件
└── models/            # 数据模型
```

### 4.2 后端架构
**技术栈**:
- **语言**: Dart
- **框架**: Shelf
- **功能**: 代理服务器、API 签名、转链

**核心功能**:
- OpenAI API 代理转发
- 淘宝联盟签名和转链 (`/sign/taobao`, `/taobao/convert`)
- 京东联盟签名和转链 (`/sign/jd`, `/jd/union/promotion/bysubunionid`)
- 拼多多推广链接生成 (`/sign/pdd`)
- 管理员登录验证 (`/admin/login`)

**环境变量配置**:
- `TAOBAO_APP_SECRET`: 淘宝应用密钥
- `JD_APP_SECRET`: 京东联盟密钥
- `JD_APP_KEY`: 京东应用 Key
- `JD_UNION_ID`: 京东联盟 ID
- `PDD_CLIENT_ID`: 拼多多客户端 ID
- `PDD_CLIENT_SECRET`: 拼多多客户端密钥
- `PDD_PID`: 拼多多推广位 ID
- `ADMIN_PASSWORD`: 管理员密码

### 4.3 数据存储
**本地存储**:
- **Hive**: 用于存储设置、选品车、会话历史、推广链接缓存
- **存储内容**:
  - `settings`: 应用设置（API Key、后端地址等）
  - `cart`: 选品车数据
  - `conversations`: 会话历史
  - `promo_cache`: 推广链接缓存

### 4.4 跨平台支持
- **桌面端**: Windows、macOS、Linux
- **移动端**: Android、iOS
- **Web**: 浏览器支持

---

## 5. 功能需求详细说明

### 5.1 AI 助手聊天功能

#### 5.1.1 基础对话
- **需求**: 用户可以通过文本输入与 AI 进行对话
- **输入**: 用户文本消息
- **输出**: AI 文本回复（支持流式响应）
- **优先级**: P0（核心功能）

#### 5.1.2 商品推荐
- **需求**: AI 能够识别用户推荐请求，返回结构化商品推荐
- **输入**: 用户描述需求（如"推荐一款 800 元左右的 USB DAC"）
- **输出**: JSON 格式推荐列表，包含商品信息、价格、链接等
- **优先级**: P0（核心功能）

#### 5.1.3 会话管理
- **需求**: 支持多会话，每个会话有独立标题和历史记录
- **功能**: 创建新会话、切换会话、删除会话、自动保存
- **优先级**: P1（重要功能）

#### 5.1.4 流式响应
- **需求**: AI 回复支持流式显示，提升用户体验
- **技术**: SSE (Server-Sent Events) 或类似流式协议
- **优先级**: P1（重要功能）

### 5.2 商品搜索功能

#### 5.2.1 关键词搜索
- **需求**: 用户输入关键词，搜索多个平台商品
- **支持平台**: 淘宝、京东、拼多多
- **搜索模式**: 单平台搜索、全平台搜索
- **优先级**: P0（核心功能）

#### 5.2.2 搜索结果展示
- **需求**: 统一展示不同平台的商品信息
- **展示内容**: 商品图片、标题、价格、销量、评分、店铺名
- **排序**: 默认按平台优先级（京东 > 淘宝 > 拼多多）
- **优先级**: P0（核心功能）

#### 5.2.3 分页加载
- **需求**: 支持分页加载更多商品
- **默认**: 每页 10 条
- **优先级**: P1（重要功能）

### 5.3 选品车功能

#### 5.3.1 添加商品
- **需求**: 从商品列表或详情页添加商品到选品车
- **功能**: 支持数量设置、自动去重
- **优先级**: P0（核心功能）

#### 5.3.2 商品管理
- **需求**: 支持删除、修改数量、批量选择
- **功能**: 按店铺分组、全选/取消全选
- **优先级**: P0（核心功能）

#### 5.3.3 价格监控
- **需求**: 自动刷新选品车中商品价格
- **频率**: 可配置（建议 5-10 分钟）
- **通知**: 价格变化时发送本地通知
- **优先级**: P1（重要功能）

#### 5.3.4 结算功能
- **需求**: 批量复制选中商品的推广链接
- **功能**: 显示商品列表，支持单个或批量复制
- **优先级**: P1（重要功能）

### 5.4 推广链接生成

#### 5.4.1 自动生成
- **需求**: 为商品自动生成推广链接
- **支持平台**: 淘宝、京东、拼多多
- **链接类型**: 普通链接、短链接、口令（tpwd）
- **优先级**: P0（核心功能）

#### 5.4.2 链接缓存
- **需求**: 生成的链接缓存 30 分钟，避免重复请求
- **存储**: 内存缓存 + Hive 持久化
- **优先级**: P1（重要功能）

#### 5.4.3 链接复制
- **需求**: 一键复制推广链接到剪贴板
- **功能**: 支持复制链接、复制口令
- **优先级**: P0（核心功能）

### 5.5 管理员设置

#### 5.5.1 API 配置
- **需求**: 配置 OpenAI API Key、后端地址、模型等
- **功能**: 支持保存、验证、重置
- **优先级**: P1（重要功能）

#### 5.5.2 高级选项
- **需求**: 提供调试、Mock 模式等高级选项
- **功能**: Prompt 嵌入开关、调试模式、Mock AI、Max Tokens 配置
- **优先级**: P2（可选功能）

---

## 6. 非功能性需求

### 6.1 性能需求
- **响应时间**: AI 回复首次响应 < 3 秒（流式）
- **搜索速度**: 多平台搜索 < 5 秒
- **页面加载**: 应用启动 < 2 秒
- **流畅度**: 60 FPS 动画

### 6.2 可用性需求
- **易用性**: 界面简洁直观，新用户 5 分钟内上手
- **可访问性**: 支持深色模式、系统字体设置
- **多语言**: 主要支持中文（简体）

### 6.3 可靠性需求
- **错误处理**: 网络错误、API 错误有友好提示
- **数据持久化**: 选品车、会话历史本地持久化
- **离线支持**: 支持查看本地缓存数据（Mock 模式）

### 6.4 安全性需求
- **API Key 保护**: 本地加密存储，不提交到版本控制
- **管理员验证**: 管理员入口需要密码验证
- **HTTPS**: 生产环境使用 HTTPS 通信

### 6.5 兼容性需求
- **操作系统**: Windows 10+, macOS 10.14+, Linux (主流发行版)
- **移动端**: Android 5.0+, iOS 12.0+
- **浏览器**: Chrome 90+, Safari 14+, Firefox 88+

### 6.6 可维护性需求
- **代码质量**: 遵循 Flutter/Dart 最佳实践
- **测试覆盖**: 核心功能单元测试覆盖 > 60%
- **文档**: API 文档、代码注释完善

---

## 7. 用户界面设计

### 7.1 设计原则
- **Material Design 3**: 遵循 Material Design 设计规范
- **响应式布局**: 支持桌面端和移动端自适应
- **深色模式**: 支持系统级深色模式切换

### 7.2 主要页面

#### 7.2.1 聊天页面
- **布局**: 消息列表 + 输入框 + 建议卡片
- **交互**: 发送消息、流式显示、商品卡片点击
- **功能**: 会话切换、清空对话、复制消息

#### 7.2.2 选品车页面
- **布局**: 商品列表（按店铺分组）+ 底部结算栏
- **交互**: 选择、删除、数量调整、结算
- **功能**: 全选、按店铺筛选、价格刷新

#### 7.2.3 商品详情页面
- **布局**: 商品图片、信息、操作按钮
- **交互**: 查看详情、加入选品车、复制链接
- **功能**: 外部链接跳转、分享

#### 7.2.4 设置页面
- **布局**: 分类设置卡片
- **交互**: 输入、选择、开关
- **功能**: 保存设置、重置、验证

---

## 8. 数据模型

### 8.1 商品模型 (ProductModel)
```dart
{
  id: String,              // 商品 ID
  platform: String,        // 平台 (taobao/jd/pdd)
  title: String,          // 商品标题
  price: double,          // 价格
  originalPrice: double,  // 原价
  coupon: double,         // 优惠券金额
  finalPrice: double,     // 最终价格
  imageUrl: String,       // 图片 URL
  sales: int,             // 销量
  rating: double,         // 评分 (0.0-1.0)
  shopTitle: String,      // 店铺名
  link: String,           // 商品链接
  commission: double,     // 佣金
  description: String     // 描述
}
```

### 8.2 消息模型 (ChatMessage)
```dart
{
  id: String,             // 消息 ID
  role: String,           // 角色 (user/assistant)
  content: String,        // 消息内容
  timestamp: DateTime,    // 时间戳
  products: List<ProductModel>?  // 关联商品（可选）
}
```

### 8.3 会话模型 (Conversation)
```dart
{
  id: String,             // 会话 ID
  title: String,          // 会话标题
  messages: List<ChatMessage>,  // 消息列表
  createdAt: DateTime,    // 创建时间
  updatedAt: DateTime     // 更新时间
}
```

---

## 9. API 接口设计

### 9.1 前端调用后端接口

#### 9.1.1 AI 聊天接口
- **端点**: `POST /v1/chat/completions`
- **功能**: 获取 AI 回复（支持流式）
- **请求体**: OpenAI 兼容格式
- **响应**: JSON 或 SSE 流

#### 9.1.2 推广链接生成
- **淘宝**: `POST /sign/taobao` 或 `POST /taobao/convert`
- **京东**: `POST /sign/jd` 或 `POST /jd/union/promotion/bysubunionid`
- **拼多多**: `POST /sign/pdd`

#### 9.1.3 管理员接口
- **登录**: `POST /admin/login`
- **功能**: 验证管理员密码

### 9.2 第三方 API 集成

#### 9.2.1 淘宝联盟 API
- **搜索**: 通过后端代理
- **转链**: 后端处理签名和转链

#### 9.2.2 京东联盟 API
- **搜索**: 直接调用或通过后端
- **转链**: 后端处理签名和转链

#### 9.2.3 拼多多 API
- **搜索**: 直接调用
- **转链**: 后端处理签名和转链

---

## 10. 错误处理

### 10.1 网络错误
- **处理**: 显示友好错误提示，支持重试
- **提示**: "网络连接失败，请检查网络设置"

### 10.2 API 错误
- **处理**: 根据错误码显示不同提示
- **常见错误**:
  - 429: 请求过多，提示稍后重试
  - 401: API Key 无效，提示检查配置
  - 500: 服务器错误，提示联系管理员

### 10.3 数据错误
- **处理**: 数据解析失败时使用默认值或跳过
- **日志**: 记录错误信息便于调试

---

## 11. 测试策略

### 11.1 单元测试
- **覆盖范围**: Service 层、Adapter 层、工具函数
- **测试文件**: `test/` 目录
- **覆盖率目标**: > 60%

### 11.2 集成测试
- **覆盖范围**: API 调用、数据存储、状态管理
- **测试场景**: 完整用户流程

### 11.3 UI 测试
- **覆盖范围**: 主要页面交互
- **测试工具**: Flutter Widget Tests

### 11.4 手动测试
- **测试场景**: 多平台搜索、AI 对话、选品车操作
- **测试设备**: 不同操作系统、不同屏幕尺寸

---

## 12. 部署和发布

### 12.1 前端部署
- **桌面端**: 打包为可执行文件（Windows .exe, macOS .app, Linux AppImage）
- **移动端**: 发布到应用商店（Android Google Play, iOS App Store）
- **Web**: 部署到静态托管服务（如 Vercel、Netlify）

### 12.2 后端部署
- **服务器**: 支持 Linux 服务器部署
- **运行方式**: `dart run server/bin/proxy_server.dart`
- **进程管理**: 建议使用 PM2 或 systemd
- **环境变量**: 通过 `.env` 文件或系统环境变量配置

### 12.3 版本管理
- **版本号**: 遵循语义化版本（Semantic Versioning）
- **发布流程**: 开发 → 测试 → 预发布 → 正式发布

---

## 13. 未来规划

### 13.1 短期规划 (3 个月内)
- [ ] 优化 AI 推荐准确性
- [ ] 增加更多商品筛选条件（价格区间、销量排序等）
- [ ] 完善价格监控和通知功能
- [ ] 支持更多电商平台（如天猫、苏宁等）

### 13.2 中期规划 (6 个月内)
- [ ] 用户账户系统（云同步选品车和会话）
- [ ] 商品比价功能（同一商品在不同平台的价格对比）
- [ ] 商品评价分析（AI 分析用户评价）
- [ ] 优惠券聚合和提醒

### 13.3 长期规划 (1 年内)
- [ ] 社交功能（分享选品清单、推荐给好友）
- [ ] 数据分析（用户购物偏好分析、推荐优化）
- [ ] 开放 API（供第三方开发者集成）
- [ ] 多语言支持（英文、繁体中文等）

---

## 14. 风险评估

### 14.1 技术风险
- **API 依赖**: 第三方 API 变更可能导致功能失效
  - **缓解措施**: 使用 Adapter 模式，便于替换实现
- **AI 成本**: OpenAI API 调用成本可能较高
  - **缓解措施**: 支持本地代理、Mock 模式、缓存机制

### 14.2 业务风险
- **平台政策**: 电商平台可能限制 API 访问
  - **缓解措施**: 多样化平台支持，降低单平台依赖
- **推广合规**: 需要遵守各平台推广规则
  - **缓解措施**: 明确提示用户遵守平台规则

### 14.3 用户风险
- **数据隐私**: 用户数据本地存储，不涉及隐私泄露
- **API Key 安全**: 用户自行保管 API Key，应用不收集

---

## 15. 成功指标

### 15.1 用户指标
- **日活跃用户 (DAU)**: 目标 1000+
- **用户留存率**: 7 日留存 > 30%
- **平均会话时长**: > 5 分钟

### 15.2 功能指标
- **AI 推荐准确率**: 用户满意度 > 70%
- **搜索成功率**: 搜索成功率 > 95%
- **推广链接生成成功率**: > 90%

### 15.3 技术指标
- **应用崩溃率**: < 0.1%
- **API 响应时间**: 平均 < 2 秒
- **页面加载时间**: < 1 秒

---

## 16. 附录

### 16.1 术语表
- **推广链接**: 包含推广者信息的商品链接，用户通过该链接购买推广者可获得佣金
- **选品车**: 用户收藏感兴趣商品的列表，类似购物车
- **转链**: 将普通商品链接转换为推广链接的过程
- **tpwd**: 淘宝口令，一种短链接形式
- **Adapter 模式**: 设计模式，用于适配不同平台的 API

### 16.2 参考文档
- [Flutter 官方文档](https://docs.flutter.dev/)
- [OpenAI API 文档](https://platform.openai.com/docs)
- [淘宝联盟 API](https://open.taobao.com/)
- [京东联盟 API](https://union.jd.com/)
- [拼多多开放平台](https://open.pinduoduo.com/)

### 16.3 变更日志
- **v1.0** (2025): 初始 PRD 版本

---

**文档维护者**: 产品团队  
**审核者**: 技术团队、设计团队  
**批准者**: 产品负责人

